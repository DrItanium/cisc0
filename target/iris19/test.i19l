(@org 0x00100000)
(@label StackStart)

(@org 0x00000000)
; TODO: implement memory management logic
(macro use
       (?register $?body)
       (push sp
             ?register)
       $?body
       (bind ?register
             (pop sp)))
(macro return
       ()
       (bind ip
             (pop sp)))

(scope car
       (use r0
            (push value
                  (load (bind r0
                              (pop value)))))
       (return))
(scope cdr
       (use r0
            (push value
                  (load (bind r0
                              (add (pop value)
                                   (immediate 1))))))
       (return))

(push sp
      (load (push (bind sp
                        (immediate StackStart))
                  (immediate string
                             0m11111111))))

(bind r3
      (bind r2
            (bind r0
                  (immediate 0
                             0m00000000))))
(bind r1
      (immediate 0x2
                 0m00000001))
(scope continue
       (if (bind r4
                 (== (bind r3
                           (load sp)
                           (bitmask 0m00001111)))) then
         (immediate done))
       (system r1
               r3)
       (push sp
             (add (pop sp)
                  (immediate 1)))
       (branch (immediate continue)))
(scope done
       (system r0
               r0))


(def (string (list 0x46 0x75 0x63 0x6B 0x20 0x79 0x6F 0x75 0x20 0x4D 0x65 0x6E 0x64
                   0x65 0x7A 0x2E 0x0A 0x46 0x75 0x63 0x6B 0x20 0x79 0x6F 0x75 0x20 0x41 0x69
                   0x72 0x65 0x6E 0x2E 0x0A 0x00)))
